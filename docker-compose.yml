version: '3.8'
services:
  tomcat:
    hostname: tomcat.lab
    image: 'tomcat:9.0.83'
    volumes:
      - ./data/jsp:/usr/local/tomcat/webapps/webapp
    environment:
      - http_proxy=http://10.20.0.20:8080
      - http_proxys=http://10.20.0.20:8080
    depends_on:
      - mitmproxy
    dns:
      - 10.20.0.23
    networks:
      research:
        ipv4_address: 10.20.0.10

  dotnet:
    hostname: dotnet.lab
    build:
      context: .
      dockerfile: build/dotnet.Dockerfile
    image: 'csalab/dotnet:latest'
    environment:
      - TZ=UTC
      - http_proxy=http://10.20.0.20:8080
      - http_proxys=http://10.20.0.20:8080
    depends_on:
      - mitmproxy
    dns:
      - 10.20.0.23
    networks:
      research:
        ipv4_address: 10.20.0.11

  php5:
    hostname: php5.lab
    build:
      context: .
      dockerfile: build/php5.Dockerfile
    image: 'csalab/thestrack-php5:latest'
    volumes:
      - ./data/php:/var/www/html
    environment:
      - http_proxy=http://10.20.0.20:8080
      - http_proxys=http://10.20.0.20:8080
    depends_on:
      - mitmproxy
    dns:
      - 10.20.0.23
    command: >
      bash -c "socat TCP-LISTEN:1025,fork TCP:10.20.0.25:1025 & apache2-foreground"
    networks:
      research:
        ipv4_address: 10.20.0.15

  php7:
    hostname: php7.lab
    build:
      context: .
      dockerfile: build/php7.Dockerfile
    image: 'csalab/thestrack-php7:latest'
    volumes:
      - ./data/php:/var/www/html
    environment:
      - http_proxy=http://10.20.0.20:8080
      - http_proxys=http://10.20.0.20:8080
    depends_on:
      - mitmproxy
    dns:
      - 10.20.0.23
    command: >
      bash -c "socat TCP-LISTEN:1025,fork TCP:10.20.0.25:1025 & apache2-foreground"
    networks:
      research:
        ipv4_address: 10.20.0.16

  php8:
    hostname: php8.lab
    build:
      context: .
      dockerfile: build/php8.Dockerfile
    image: 'csalab/thestrack-php8:latest'
    volumes:
      - ./data/php:/var/www/html
    environment:
      - http_proxy=http://10.20.0.20:8080
      - http_proxys=http://10.20.0.20:8080
    depends_on:
      - mitmproxy
    dns:
      - 10.20.0.23
    command: >
      bash -c "socat TCP-LISTEN:1025,fork TCP:10.20.0.25:1025 & apache2-foreground"
    networks:
      research:
        ipv4_address: 10.20.0.17
  
  mitmproxy:
    hostname: mitmproxy.lab
    image: 'mitmproxy/mitmproxy:10.1.5'
    command: ["mitmweb", "--web-host", "0.0.0.0"]
    volumes:
      - mitmproxy:/home/mitmproxy/.mitmproxy
    dns:
      - 10.21.0.23
    depends_on:
      - pihole
    networks:
      public:
        ipv4_address: 10.21.0.20
      research:
        ipv4_address: 10.20.0.20

  sandbox:
    hostname: sandbox.lab
    build:
      context: .
      dockerfile: build/sandbox.Dockerfile
    image: 'csalab/thestrack-sandbox:latest'
    environment:
      - PASSWORD=${PASSWORD:-password}
      - http_proxy=http://10.20.0.20:8080
      - http_proxys=http://10.20.0.20:8080
    volumes:
      - ./data/data:/root/data
    dns:
      - 10.20.0.23
    depends_on:
      - mitmproxy
    networks:
      research:
        ipv4_address: 10.20.0.21

  socat:
    hostname: socat.lab
    image: 'alpine/socat:1.7.4.4'
    ports:
      - 0.0.0.0:8080:8080
    depends_on:
      - sandbox
    entrypoint: ["socat", "TCP-LISTEN:8080,fork", "TCP:10.20.0.21:80"]
    networks:
      public:
        ipv4_address: 10.21.0.22
      research:
        ipv4_address: 10.20.0.22
  
  pihole:
    hostname: pihole.lab
    image: 'pihole/pihole:latest'
    environment:
      - TZ=Asia/Jakarta
      - WEBPASSWORD=${PASSWORD:-password}
    volumes:
      - pihole_etc:/etc/pihole
      - pihole_dns:/etc/dnsmasq.d
    cap_add:
      - NET_ADMIN
    networks:
      public:
        ipv4_address: 10.21.0.23
      research:
        ipv4_address: 10.20.0.23

  unsandbox:
    hostname: unsandbox.lab
    build:
      context: .
      dockerfile: build/unsandbox.Dockerfile
    image: 'csalab/thestrack-unsandbox:latest'
    ports:
      - 0.0.0.0:8000:80
    environment:
      - PASSWORD=${PASSWORD:-password}
    volumes:
      - ./data/data:/root/data
    dns:
      - 10.21.0.23
    networks:
      public:
        ipv4_address: 10.21.0.24
      research:
        ipv4_address: 10.20.0.24

  mailhog:
    hostname: mailhog.lab
    build:
      context: .
      dockerfile: build/mailhog.Dockerfile
    image: 'csalab/thestrack-mailhog:latest'
    restart: always
    networks:
      public:
        ipv4_address: 10.21.0.25
      research:
        ipv4_address: 10.20.0.25

networks:
  public:
    driver: bridge
    ipam:
      config:
        - subnet: 10.21.0.0/24
          gateway: 10.21.0.1
  research:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 10.20.0.0/24
          gateway: 10.20.0.1

volumes:
  pihole_etc: {}
  pihole_dns: {}
  mitmproxy: {}